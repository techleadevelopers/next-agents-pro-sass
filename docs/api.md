
# üß† Roadmap T√©cnico Completo do Backend ‚Äì NextAgent-Pro

Plataforma SaaS White-label com IA Local, WhatsApp SDK, Arquitetura Clean e Suporte Multi-Tenant via Prisma ORM + NestJS.

---

## ‚öôÔ∏è Estrutura Geral do Backend

apps/ ‚îî‚îÄ‚îÄ api/ ‚îú‚îÄ‚îÄ main.ts # Bootstrap principal ‚îú‚îÄ‚îÄ app.module.ts # M√≥dulo raiz ‚îú‚îÄ‚îÄ prisma/ # PrismaService e Config ORM ‚îú‚îÄ‚îÄ shared/ # Interceptors, Pipes, Decorators ‚îú‚îÄ‚îÄ auth/ # Login, JWT, Guards ‚îî‚îÄ‚îÄ modules/ # M√≥dulos por dom√≠nio DDD

yaml
Copiar
Editar

---

## üß© M√≥dulos por Dom√≠nio (camada /modules)

| M√≥dulo        | Pasta              | Finalidade                                                                  |
|---------------|--------------------|-----------------------------------------------------------------------------|
| agents        | agents/            | Gest√£o de HiperAgentes IA personalizados por nicho                         |
| whatsapp      | whatsapp/          | Sess√µes, envio de mensagem, QR e conex√£o com Baileys                       |
| finance       | finance/           | Pagamentos, Faturas, KPIs financeiros (MRR, churn, upsell)                |
| metrics       | metrics/           | M√©tricas de performance IA                                                 |
| templates     | templates/         | Biblioteca de fluxos IA prontos                                            |
| settings      | settings/          | Configura√ß√µes IA por agente (voz, idioma, fallback, tools)                |
| logs          | logs/              | Hist√≥rico de intera√ß√µes, mensagens e erros da IA                           |
| dashboard     | dashboard/         | Combina√ß√£o de KPIs visuais                                                 |
| integrations  | integrations/      | Webhooks, CRMs e ERPs externos                                             |
| support       | support/           | Central de ajuda (FAQ, v√≠deos)                                             |
| reports       | reports/           | Gera√ß√£o e exporta√ß√£o de relat√≥rios                                         |
| debug         | debug/             | Diagn√≥stico de agentes, IA e WhatsApp                                      |
| flows         | flows/             | (Planejado) Builder IA drag & drop                                         |
| voice         | voice/             | (Futuro) Integra√ß√£o com TTS / STT                                          |
| billing       | billing/           | (Futuro) Planos, assinaturas, cobran√ßa integrada                           |
| analytics     | analytics/         | (Futuro) An√°lise de comportamento IA e usu√°rios                            |

---

## üîå Endpoints REST (por m√≥dulo)

### üì¶ Agents
- `GET /agents` ‚Äî Lista agentes
- `POST /agents` ‚Äî Cria novo agente
- `GET /agents/:id` ‚Äî Detalhes do agente
- `PATCH /agents/:id` ‚Äî Atualiza agente
- `DELETE /agents/:id` ‚Äî Remove agente

---

### üì≤ WhatsApp
- `POST /whatsapp/:agentId/send-message`
- `POST /whatsapp/:agentId/sessions/init`
- `GET /whatsapp/:agentId/status`
- `GET /whatsapp/:agentId/sessions`
- `DELETE /whatsapp/:agentId/sessions/:sessionId`

---

### üí∞ Financeiro
- `GET /financeiro/historico?start=...&end=...`
- `GET /financeiro/mrr?periodo=mensal`
- `GET /financeiro/retencao-churn`
- `GET /financeiro/upsell`
- `GET /financeiro/kpis`
- `GET /financeiro/faturas`

---

### üß† IA LangChain
- `POST /ia/ask-to-agent`
- `POST /ia/flow/:agentId/start` *(planejado)*
- `POST /ia/flow/:agentId/continue` *(planejado)*

---

### üìà M√©tricas
- `GET /metricas/mensagens-por-periodo`
- `GET /metricas/conversao-por-agente`
- `GET /metricas/evolucao-uso`

---

### üßæ Logs
- `GET /logs?agentId=...`
- `GET /logs/:logId`
- `DELETE /logs/:logId`

---

### ‚öôÔ∏è Settings
- `GET /settings/:agentId`
- `PATCH /settings/:agentId`
- `PATCH /settings/:agentId/tools`
- `PATCH /settings/:agentId/voice`

---

### üß™ Debug
- `GET /debug/agents/:id/status`
- `GET /debug/langchain/:agentId`
- `GET /debug/whatsapp/:agentId/connection`

---

## üß¨ Prisma ORM ‚Äì Modelos Relacionais

| Modelo              | Descri√ß√£o                                               |
|---------------------|----------------------------------------------------------|
| Agent               | Agente IA vinculado a tenant                             |
| Cliente             | Tenant master                                            |
| Pagamento           | Registro financeiro avulso                               |
| FaturaMensal        | Fatura consolidada por m√™s                               |
| KpiFinance          | MRR, churn, upsell e receita                             |
| Upsell              | Vendas extras (upgrade de plano)                         |
| Assinatura          | Assinatura de plano SaaS                                 |
| Plano               | Plano SaaS dispon√≠vel (B√°sico, Pro, White-label)         |
| Mensagem            | Mensagens trocadas no WhatsApp                           |
| WhatsAppSession     | Sess√µes de conex√£o com status                            |
| DocumentoTreinado   | Arquivo enviado para embedding IA                        |
| VetorDocumento      | Chunks vetorizados (LangChain/Ollama)                    |
| Settings            | Configura√ß√£o IA (voz, idioma, fallback, tools)           |
| Log                 | Hist√≥rico de IA (mensagens, erros, eventos)              |
| Faq                 | Perguntas frequentes (suporte)                           |
| VideoTutorial       | Conte√∫do em v√≠deo (suporte IA)                           |
| Template            | Fluxos IA reutiliz√°veis por categoria                    |

---

## üîê Multi-Tenant

- `x-tenant-id` no header obrigat√≥rio em todas as rotas privadas
- Prisma filtra via: `{ where: { tenantId } }`
- Decorator `@CurrentTenant()` para extrair o tenantId direto
- `TenantInterceptor` injeta automaticamente

---

## ‚öôÔ∏è Shared Layer (apps/api/src/shared)

| Tipo        | Arquivo                      | Fun√ß√£o                                                        |
|-------------|------------------------------|---------------------------------------------------------------|
| Decorator   | `current-tenant.decorator.ts`| Injeta tenantId do header                                     |
| Decorator   | `public.decorator.ts`        | Define rota p√∫blica sem JWT                                   |
| Interceptor | `tenant.interceptor.ts`      | Injeta tenantId nas requisi√ß√µes automaticamente               |
| Pipe        | `parse-date.pipe.ts`         | Converte query string de data para `Date`                     |
| Guard       | `jwt-auth.guard.ts`          | Valida JWT do usu√°rio                                         |

---

## üîó Integra√ß√µes e Tecnologias

| Stack          | Lib / Tool         | Uso principal                                      |
|----------------|--------------------|----------------------------------------------------|
| ORM            | Prisma ORM         | Models, Migrations, Multi-Tenant                   |
| DB             | PostgreSQL         | Banco relacional                                   |
| LangChain      | LangChain.js       | Agentes IA locais, mem√≥ria, embeddings             |
| IA Local       | Ollama             | Rodar LLMs no servidor (Phi, Mistral, TinyLlama)  |
| WhatsApp SDK   | Baileys            | Envio/recebimento de mensagens, sess√£o, status     |
| Queue          | BullMQ (futuro)    | Envio ass√≠ncrono de mensagens                      |
| DevOps         | TurboRepo + GitHub | Monorepo, CI/CD, Lint, Deploy                      |

---

## üîÅ Fluxo de Execu√ß√£o

```ts
POST /whatsapp/:agentId/send-message

‚Üì WhatsAppController
‚Üì WhatsAppService
‚Üì LangChainStrategy (agents-core)
‚Üì WhatsAppClient (Baileys SDK)
‚Üì Queue opcional (BullMQ)
‚Üì JSON Response
‚úÖ Padr√µes Arquiteturais
‚úÖ Clean Architecture (domain, infra, use-case separados)

‚úÖ DDD (cada m√≥dulo √© um bounded context)

‚úÖ CQRS (leitura e escrita separadas em alguns dom√≠nios)

‚úÖ Multi-Tenant isolado por header

‚úÖ DTOs para entrada/sa√≠da clara entre camadas

‚úÖ Interceptors, Guards, Decorators para controle fino

üìö Pr√≥ximos M√≥dulos Planejados

M√≥dulo	Status	Descri√ß√£o
flows	Planejado	FlowBuilder visual IA (drag & drop)
analytics	Planejado	Comportamento IA + visualiza√ß√µes
billing	Futuro	Integra√ß√£o com gateways de pagamento
voice	Futuro	TTS / STT via IA de voz
notifications	Futuro	Hist√≥rico de eventos, alertas IA
üöÄ Conclus√£o
O backend do NextAgent-Pro oferece uma funda√ß√£o s√≥lida para produtos SaaS com IA local, automa√ß√µes via WhatsApp, total isolamento por tenant, integra√ß√£o com dados reais, e pronto para escalar.

‚úÖ Clean Architecture
‚úÖ Multi-Tenant com Prisma
‚úÖ IA Local via LangChain/Ollama
‚úÖ Sess√µes WhatsApp em tempo real
‚úÖ Modular, test√°vel e pronto pra White-label
Desenvolvido por:
Paulo Silas de Campos Filho
TechLead @ NextAgent-Pro




<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->


 M√≥dulo whatsapp (DDD + Clean)
pgsql
Copiar
Editar
apps/
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ src/
        ‚îî‚îÄ‚îÄ modules/
            ‚îî‚îÄ‚îÄ whatsapp/
                ‚îú‚îÄ‚îÄ domain/
                ‚îÇ   ‚îú‚îÄ‚îÄ entities/
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp-session.entity.ts
                ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.repository.ts
                ‚îÇ   ‚îî‚îÄ‚îÄ value-objects/
                ‚îÇ       ‚îî‚îÄ‚îÄ whatsapp-status.vo.ts
                ‚îÇ
                ‚îú‚îÄ‚îÄ application/
                ‚îÇ   ‚îú‚îÄ‚îÄ use-cases/
                ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send-message.use-case.ts
                ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init-session.use-case.ts
                ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ disconnect-session.use-case.ts
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get-session-status.use-case.ts
                ‚îÇ   ‚îî‚îÄ‚îÄ dto/
                ‚îÇ       ‚îú‚îÄ‚îÄ send-message.dto.ts
                ‚îÇ       ‚îú‚îÄ‚îÄ init-session.dto.ts
                ‚îÇ       ‚îî‚îÄ‚îÄ session-status.dto.ts
                ‚îÇ
                ‚îú‚îÄ‚îÄ infrastructure/
                ‚îÇ   ‚îú‚îÄ‚îÄ database/
                ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prisma/
                ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.prisma.ts
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.repository.impl.ts
                ‚îÇ   ‚îú‚îÄ‚îÄ client/
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ baileys.client.ts
                ‚îÇ   ‚îú‚îÄ‚îÄ gateways/
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.gateway.ts  # (WebSocket - Status em tempo real)
                ‚îÇ   ‚îî‚îÄ‚îÄ queue/
                ‚îÇ       ‚îî‚îÄ‚îÄ whatsapp.queue.ts     # Worker BullMQ (envio ass√≠ncrono)
                ‚îÇ
                ‚îú‚îÄ‚îÄ presentation/
                ‚îÇ   ‚îú‚îÄ‚îÄ controllers/
                ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ whatsapp.controller.ts
                ‚îÇ   ‚îî‚îÄ‚îÄ routes/
                ‚îÇ       ‚îî‚îÄ‚îÄ whatsapp.routes.ts
                ‚îÇ
                ‚îî‚îÄ‚îÄ config/
                    ‚îî‚îÄ‚îÄ whatsapp.config.ts
üîç Explica√ß√£o Modular

Pasta/Arquivo	Descri√ß√£o
domain/entities/whatsapp-session.entity.ts	Entidade representando uma sess√£o WhatsApp (n√∫mero, status, agentId, tenantId, etc).
domain/repositories/	Abstra√ß√£o da persist√™ncia para sess√µes e logs (interface).
domain/value-objects/	Representa√ß√µes imut√°veis como status (CONNECTED, DISCONNECTED, LOADING_QR, etc).
application/use-cases/	Casos de uso encapsulando l√≥gica como "iniciar sess√£o", "enviar mensagem", "desconectar".
application/dto/	Tipagens e valida√ß√µes para entrada e sa√≠da nos use-cases.
infrastructure/client/baileys.client.ts	Wrapper para SDK Baileys, gerencia inst√¢ncias, QR Codes, envio e recep√ß√£o.
infrastructure/queue/	Sistema de filas com BullMQ para envio ass√≠ncrono de mensagens.
infrastructure/gateways/whatsapp.gateway.ts	WebSocket para push status (QR Code, eventos de mensagem, status de sess√£o).
infrastructure/database/prisma/	Schema e repository real implementando a interface do dom√≠nio.
presentation/controllers/whatsapp.controller.ts	Controller REST integrando com use-cases.
config/whatsapp.config.ts	Configs como timeout de sess√£o, max conex√µes, logs, paths.
üåê Endpoints (REST) - J√° Alinhados com Estrutura

Verbo	Rota	Caso de uso
POST	/whatsapp/:agentId/send-message	send-message.use-case.ts
POST	/whatsapp/:agentId/sessions/init	init-session.use-case.ts
DELETE	/whatsapp/:agentId/sessions/:sessionId	disconnect-session.use-case.ts
GET	/whatsapp/:agentId/status	get-session-status.use-case.ts
GET	/debug/whatsapp/:agentId/connection	Diagn√≥stico de sess√£o (baileys.client.ts)
üîÅ Fluxo de Envio de Mensagens via Baileys (Async com IA)
User envia mensagem para um n√∫mero ‚Üí /send-message

API chama SendMessageUseCase

UseCase envia mensagem para fila (BullMQ)

Worker (whatsapp.queue.ts) consome a fila e chama baileys.client.ts

Cliente WhatsApp envia a mensagem

Log e status da entrega s√£o salvos via reposit√≥rio

Resposta √© enviada de volta ao frontend via Socket Gateway

üéØ Alinhamento com Estrat√©gia SaaS

Requisito	Como a estrutura cobre
Multi-Tenant	Toda entidade e sess√£o carrega tenantId, agentId como chave obrigat√≥ria
Independ√™ncia de APIs	Integra√ß√£o via Baileys SDK (open-source, local)
Gerenciamento IA por Nicho	Toda sess√£o WhatsApp est√° atrelada a um HiperAgente
Painel Futurista (HUD Sci-Fi)	A comunica√ß√£o em tempo real via whatsapp.gateway.ts alimenta status, QR Code e a√ß√µes de controle no frontend
Alta escalabilidade	Baileys √© stateless, e a orquestra√ß√£o √© feita por filas com workers isolados
Logs + M√©tricas	Cada mensagem, sess√£o e erro pode ser logado na tabela de logs, alimentando o m√≥dulo metrics/
‚úÖ Pr√≥ximos Arquivos a Codar (sugest√£o de ordem)
whatsapp-session.entity.ts (entidade base)

init-session.use-case.ts + baileys.client.ts

whatsapp.controller.ts com endpoint de /sessions/init

whatsapp.gateway.ts para emitir QR code por socket

send-message.use-case.ts + whatsapp.queue.ts

Reposit√≥rios + Prisma Model

üî• Quer que eu comece a gerar os arquivos?
Posso j√° te entregar:

 whatsapp-session.entity.ts

 init-session.use-case.ts

 baileys.client.ts

 whatsapp.controller.ts

Ou prefere que eu siga algum outro caminho?

Me fala o que voc√™ prefere: come√ßar pela base das entidades e casos de uso ou j√° ir direto para o fluxo funcional de sess√£o e envio de mensagem.


## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil My≈õliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).
